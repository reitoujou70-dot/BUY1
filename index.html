<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ¿¾èŠ¯å°èˆ–ï½œæœƒå“¡é™å®šï½œæ—¥ç³»é›œè²¨é¢¨ï¼‹è³¼ç‰©è»Š</title>
  <style>
    :root{
      --bg:#fbf8f2;
      --paper:#ffffff;
      --ink:#1f1f1f;
      --muted:#6b6b6b;
      --line:#e9e2d8;
      --accent:#2f6f55;
      --accent2:#b07a3a;
      --soft:#f6f1e7;
      --shadow:0 10px 30px rgba(0,0,0,.05);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC", "Noto Sans TC", "Segoe UI", sans-serif;
      color:var(--ink);
      background:linear-gradient(180deg,var(--bg),#fff);
    }
    a{color:inherit}
    .wrap{max-width:1160px;margin:0 auto;padding:22px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:14px;
      padding:14px 16px;border:1px solid var(--line);border-radius:var(--radius);
      background:rgba(255,255,255,.78);backdrop-filter: blur(8px);
      position:sticky;top:12px;z-index:20;flex-wrap:wrap;
      box-shadow:var(--shadow);
    }
    .brand{display:flex;flex-direction:column;gap:2px}
    .brand b{font-size:16px;letter-spacing:.06em}
    .brand small{color:var(--muted);font-size:12px}

    /* âœ… æœƒå“¡é™å®šæ¨™ç±¤ */
    .tag{
      display:inline-block;
      margin-left:8px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(176,122,58,.10);
      color:var(--accent2);
      font-size:12px;
      font-weight:700;
      letter-spacing:.04em;
      vertical-align:middle;
      white-space:nowrap;
    }

    .pills{display:flex;gap:8px;flex-wrap:wrap}
    .pill{
      font-size:12px;color:var(--muted);
      border:1px solid var(--line);
      padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.70);
      display:inline-flex;gap:6px;align-items:center;
      white-space:nowrap;
    }

    /* Hero (é›œè²¨é¢¨) */
    .hero{
      margin-top:14px;
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:16px;
      background:
        radial-gradient(900px 500px at 18% 0%, rgba(176,122,58,.18), transparent 52%),
        radial-gradient(900px 500px at 100% 100%, rgba(47,111,85,.14), transparent 58%),
        linear-gradient(180deg,rgba(255,255,255,.85),rgba(255,255,255,.72));
      box-shadow:var(--shadow);
    }
    .heroTop{display:flex;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .hero h1{margin:0;font-size:18px;letter-spacing:.04em}
    .hero p{margin:6px 0 0;color:var(--muted);font-size:12px;line-height:1.7}
    .hero .rightNote{
      margin-left:auto;
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    }

    .btn{
      border:1px solid var(--line);
      background:var(--paper);
      padding:10px 12px;border-radius:999px;
      cursor:pointer;
      display:inline-flex;gap:8px;align-items:center;
      transition:transform .05s ease, background .2s ease, filter .2s ease;
      user-select:none;
    }
    .btn:hover{background:#fff}
    .btn:active{transform:translateY(1px)}
    .btn.primary{border-color:transparent;background:var(--accent);color:#fff}
    .btn.primary:hover{filter:brightness(1.03)}
    .btn.ghost{background:rgba(255,255,255,.65)}
    .btn.dark{border-color:transparent;background:#333;color:#fff}

    /* Layout: å·¦å•†å“ / å³è³¼ç‰©è»Š */
    .layout{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.7fr 1fr;
      gap:16px;
      align-items:start;
    }
    .card{
      border:1px solid var(--line);
      background:rgba(255,255,255,.86);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow);
    }

    .toolbar{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;
      margin-bottom:12px;
    }
    .input{
      flex:1; min-width:220px;
      border:1px solid var(--line);
      border-radius:999px;
      padding:10px 12px;
      background:rgba(255,255,255,.80);
      outline:none;
      font:inherit;
    }
    .select{
      border:1px solid var(--line);
      border-radius:999px;
      padding:10px 12px;
      background:rgba(255,255,255,.80);
      outline:none;
      font:inherit;
      color:var(--ink);
    }

    .section{margin-top:14px}
    .sectionTitle{
      display:flex;align-items:baseline;justify-content:space-between;gap:10px;
      padding:6px 2px;
    }
    .sectionTitle h2{margin:0;font-size:14px;letter-spacing:.04em}
    .sectionTitle .sub{margin:0;color:var(--muted);font-size:12px}

    /* é›œè²¨é¢¨å•†å“å¡ */
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .product{
      border:1px solid var(--line);
      background:#fff;
      border-radius:16px;
      padding:12px;
      display:flex;flex-direction:column;gap:10px;
      box-shadow:0 10px 22px rgba(0,0,0,.03);
    }
    .img{
      width:100%;
      aspect-ratio: 4/3;
      border-radius:14px;
      border:1px solid var(--line);
      background:
        radial-gradient(650px 380px at 22% 0%, rgba(176,122,58,.15), transparent 52%),
        radial-gradient(650px 380px at 100% 100%, rgba(47,111,85,.13), transparent 58%),
        linear-gradient(180deg,#fff,#f7f2e9);
      display:flex;align-items:center;justify-content:center;
      color:rgba(0,0,0,.28);
      font-size:12px;letter-spacing:.08em;
    }
    .title{margin:0;font-size:13px;line-height:1.45;font-weight:780}
    .meta{display:flex;gap:6px;flex-wrap:wrap}
    .chip{
      font-size:12px;padding:5px 8px;border-radius:999px;border:1px solid var(--line);
      background:var(--soft); color:var(--muted); white-space:nowrap;
    }
    .chip.good{color:var(--accent);background:rgba(47,111,85,.08)}
    .chip.warn{color:var(--accent2);background:rgba(176,122,58,.10)}
    .topline{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .price{text-align:right;white-space:nowrap}
    .price b{font-size:14px}
    .hint{font-size:12px;color:var(--muted)}

    .row{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
    .qty{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--line);border-radius:999px;padding:8px 10px;
      background:rgba(255,255,255,.82);
    }
    .qty button{
      width:28px;height:28px;border-radius:50%;
      border:1px solid var(--line);background:#fff;cursor:pointer;
    }
    .qty input{
      width:44px;border:none;outline:none;background:transparent;
      text-align:center;font-weight:800;
    }

    /* Cart */
    .cartSticky{
      position:sticky;
      top:92px; /* header + gap */
    }
    .cartHead{display:flex;justify-content:space-between;align-items:center;gap:10px}
    .cartHead h3{margin:0;font-size:14px;letter-spacing:.04em}
    .cartList{margin-top:12px;display:flex;flex-direction:column;gap:10px}
    .cartItem{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background:#fff;
      display:flex;gap:10px;align-items:flex-start;
    }
    .cartItem .name{font-size:13px;font-weight:700;line-height:1.4}
    .cartItem .sub2{font-size:12px;color:var(--muted);margin-top:3px}
    .cartItem .right{margin-left:auto;text-align:right;min-width:110px}
    .cartItem .right .line2{font-size:12px;color:var(--muted);margin-top:3px}
    .cartEmpty{
      border:1px dashed var(--line);
      border-radius:14px;
      padding:14px;
      background:rgba(255,255,255,.65);
      color:var(--muted);
      line-height:1.7;
      font-size:12px;
    }
    .cartFooter{margin-top:12px;border-top:1px solid var(--line);padding-top:12px}
    .sum{display:flex;justify-content:space-between;align-items:baseline;gap:10px;flex-wrap:wrap}
    .sum b{font-size:16px}
    .small{font-size:12px;line-height:1.6}
    .muted{color:var(--muted)}
    .actions2{margin-top:10px;display:flex;gap:10px;flex-wrap:wrap}

    dialog{
      width:min(560px, calc(100vw - 24px));
      border:none;border-radius:18px;padding:0;
      box-shadow:0 30px 80px rgba(0,0,0,.18);
    }
    dialog::backdrop{background:rgba(0,0,0,.35)}
    .modal{padding:16px 16px 14px}
    .modal h3{margin:0 0 6px}
    .modal p{margin:0 0 12px;color:var(--muted);line-height:1.6}
    textarea.preview{
      width:100%; min-height:170px; resize:vertical;
      border:1px solid var(--line); border-radius:14px;
      padding:12px; background:#fff;
      font:inherit; line-height:1.6;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:12px;
    }

    footer{margin:16px 0;color:var(--muted);font-size:12px;text-align:center}

    @media (max-width: 1100px){
      .grid{grid-template-columns:repeat(2,1fr)}
    }
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
      header{top:0;border-radius:0;border-left:none;border-right:none}
      .wrap{padding:14px}
      .cartSticky{position:static}
    }
  </style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="brand">
      <b>æ¿¾èŠ¯å°èˆ– <span class="tag">æœƒå“¡é™å®š</span></b>
      <small>æ—¥ç³»é›œè²¨é¢¨ï½œè³¼ç‰©è»Šä¸€æ¬¡é€ Google è¡¨å–®</small>
    </div>
    <div class="pills">
      <span class="pill">ğŸŒ¿ ç•™ç™½èˆ’æœ</span>
      <span class="pill">ğŸ›’ å³å´è³¼ç‰©è»Š</span>
      <span class="pill">ğŸ”’ å€‹è³‡è¡¨å–®å¡«</span>
    </div>
  </header>

  <section class="hero">
    <div class="heroTop">
      <div>
        <h1>æŠŠæ¿¾èŠ¯ä¹Ÿç•¶æˆå°é›œè²¨åœ¨é€› âœ¨</h1>
        <p>
          å·¦é‚ŠæŒ‘å“é …ã€å³é‚Šç¢ºèªæ¸…å–®ã€‚<br/>
          çµå¸³æœƒè·³ Google è¡¨å–®ï¼Œè³¼ç‰©è»Šæ˜ç´°è‡ªå‹•å¸¶å…¥ï¼Œå» å•†å„ªæƒ ä¹Ÿæœƒè‡ªå‹•å¡«ã€Œæ˜¯ã€ã€‚
        </p>
      </div>
      <div class="rightNote">
        <span class="pill">å» å•†åˆä½œåƒ¹ï¼šå¡«å–®å¾Œå¦æä¾›</span>
        <button class="btn ghost" id="btnResetTop">é‡ç½®ç¯©é¸</button>
      </div>
    </div>
  </section>

  <div class="layout">
    <!-- LEFT: products -->
    <div class="card">
      <div class="toolbar">
        <input id="q" class="input" placeholder="æœå°‹ï¼šPP / CTO / NSF / 20å‹ / å°T / ROâ€¦" />
        <select id="filter" class="select" aria-label="ç¯©é¸">
          <option value="all">å…¨éƒ¨</option>
          <option value="10">10 å‹</option>
          <option value="20">20 å‹</option>
          <option value="PP">PP</option>
          <option value="UDF">UDF</option>
          <option value="CTO">CTO</option>
          <option value="RO">RO</option>
        </select>
        <button class="btn" id="btnReset">é‡ç½®</button>
      </div>

      <div class="section">
        <div class="sectionTitle">
          <h2>10 å‹</h2>
          <p class="sub">å¸¸ç”¨è¦æ ¼ï½œå»ºè­°å¸‚åƒ¹å±•ç¤º</p>
        </div>
        <div class="grid" id="grid10"></div>
      </div>

      <div class="section">
        <div class="sectionTitle">
          <h2>20 å‹</h2>
          <p class="sub">å¤§æµé‡ï½œå»ºè­°å¸‚åƒ¹å±•ç¤º</p>
        </div>
        <div class="grid" id="grid20"></div>
      </div>
    </div>

    <!-- RIGHT: cart -->
    <div class="cartSticky">
      <div class="card">
        <div class="cartHead">
          <h3>è³¼ç‰©è»Š</h3>
          <button class="btn ghost" id="btnClear">æ¸…ç©º</button>
        </div>

        <div class="cartList" id="cartList"></div>

        <div class="cartFooter">
          <div class="sum">
            <div class="muted small">å“é …æ•¸ / ä»¶æ•¸</div>
            <div><b id="cartCount">0</b> <span class="muted small">æ¨£</span> ãƒ» <b id="cartUnits">0</b> <span class="muted small">ä»¶</span></div>
          </div>

          <div class="sum" style="margin-top:8px">
            <div class="muted small">å»ºè­°å¸‚åƒ¹å°è¨ˆ</div>
            <div><b id="cartTotal">NT$ 0</b></div>
          </div>

          <div class="small muted" style="margin-top:6px">
            å» å•†åˆä½œåƒ¹ï¼šå¡«å–®å¾Œå¦è¡Œæä¾›ï¼ˆé¿å…è¢«æˆªåœ–æ¯”åƒ¹ï¼‰
          </div>

          <div class="actions2">
            <button class="btn" id="btnPreview">æŸ¥çœ‹æ˜ç´°</button>
            <button class="btn primary" id="btnCheckout">å‰å¾€å®‰å…¨è¨‚è³¼</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  
</div>

<dialog id="dlg">
  <div class="modal">
    <h3 id="dlgTitle">è¨‚è³¼æ˜ç´°</h3>
    <p id="dlgText">é€™æ®µæœƒè¢«å¸¶é€² Google è¡¨å–®çš„ã€Œè³¼ç‰©è»Šæ¸…å–®ã€ã€‚</p>
    <textarea class="preview" id="cartText" readonly></textarea>
    <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:10px;flex-wrap:wrap">
      <button class="btn" onclick="copyText()">è¤‡è£½</button>
      <button class="btn primary" onclick="closeDlg()">é—œé–‰</button>
    </div>
  </div>
</dialog>

<script>
  // ====== Google è¡¨å–®è¨­å®š ======
  const FORM_BASE_URL = "https://docs.google.com/forms/d/e/1FAIpQLSevs4hk_0VWenc4lzqsfvYbd0CeHnNHuRTplkcsg-PlOmyWcw/viewform";
  const ENTRY_CART   = "entry.393774224";   // è³¼ç‰©è»Šæ¸…å–®
  const ENTRY_VENDOR = "entry.1302236144";  // å» å•†å„ªæƒ ï¼ˆå€¼ï¼šæ˜¯ï¼‰

  // ====== å•†å“è³‡æ–™ ======
  const products = [
    // â€”â€” 10 å‹ï¼ˆåŸæœ¬ï¼‰â€”â€”
    { id:'pp10_5u_62',  size:'10', type:'PP',  badges:['PP','10å‹'],               name:'PP 10" çº–ç¶­æ¿¾å¿ƒ 5u ä¿é®®è†œ 62mm',                 price:30  },
    { id:'udf10_sgs',   size:'10', type:'UDF', badges:['UDF','10å‹','SGS'],         name:'UDF 10" ç²’æ´»æ€§ç¢³ ç¶ è“‹ï¼ˆå…§æ¨™SGSï¼‰',                price:150 },
    { id:'cto10_sgs',   size:'10', type:'CTO', badges:['CTO','10å‹','SGS'],         name:'CTO 10" é€æ˜å¢Šç‰‡ 1050ï¼ˆå…§æ¨™SGSï¼‰',                price:150 },
    { id:'pp10_nsf',    size:'10', type:'PP',  badges:['PP','10å‹','NSF'],          name:'PP 10" çº–ç¶­æ¿¾å¿ƒ PSN05-10"ï¼ˆNSFï¼‰',                 price:35  },
    { id:'cto10_nsf',   size:'10', type:'CTO', badges:['CTO','10å‹','NSF'],         name:'CTO 10" é€æ˜å¢Šç‰‡ å¡Šç‹€æ´»æ€§ç¢³ï¼ˆNSFï¼‰',                price:220 },
    { id:'gac10_ocb',   size:'10', type:'UDF', badges:['é¡†ç²’ç¢³','10å‹'],            name:'é¡†ç²’æ´»æ€§ç¢³æ¿¾å¿ƒ OCB-934-10"-B',                     price:180 },

    // â€”â€” 10 å‹ï¼ˆæ–°å¢ï¼šå°T / RO / æ¨¹è„‚ï¼‰â€”â€”
    { id:'t_post_coconut', size:'10', type:'CTO', badges:['å°T','å¾Œç½®','æ¤°æ®¼'],     name:'å°T å¾Œç½® æ¤°æ®¼æ´»æ€§ç¢³',                              price:300 },
    { id:'t_post_112ca_sgs',size:'10', type:'CTO', badges:['å°T','å¾Œç½®','SGS'],     name:'å°T å¾Œç½® æ´»æ€§ç¢³ 112-CAï¼ˆSGSï¼‰',                     price:300 },
    { id:'t_post_maifan_y',  size:'10', type:'UDF', badges:['å°T','å¾Œç½®','éº¥é£¯çŸ³'],  name:'å°T å¾Œç½® éº¥é£¯çŸ³ï¼ˆé»ƒè‰²ï¼‰',                          price:350 },
    { id:'t_post_4in1',      size:'10', type:'UDF', badges:['å°T','å¾Œç½®','4åˆ1'],    name:'å°T å¾Œç½® æ¨™æº– 4 åˆ 1ï¼ˆé™¶ç“·ï¼‹éº¥é£¯çŸ³ï¼‹é ç´…å¤šç¤¦ï¼‰',      price:400 },
    { id:'ro_alp_50b',       size:'10', type:'RO',  badges:['RO','å°è£½','ALP'],      name:'RO å°è£½ï¼ˆALPï¼‰è†œ 50-B',                            price:500 },
    { id:'udf10_resin_dual', size:'10', type:'UDF', badges:['UDF','10å‹','é›™èªè­‰'],  name:'UDF 10" æ¨¹è„‚æ¿¾å¿ƒ é›™èªè­‰ é»ƒè“‹',                      price:300 },

    // â€”â€” 20 å‹ï¼ˆåŸæœ¬ï¼‰â€”â€”
    { id:'pp20_nsf',     size:'20', type:'PP',  badges:['PP','20å‹','NSF'],         name:'PP 20" çº–ç¶­æ¿¾å¿ƒ 5uï¼ˆNSFï¼‰',                        price:120 },
    { id:'cto20_paper',  size:'20', type:'CTO', badges:['CTO','20å‹','å°è£½'],        name:'CTO 20" å¡Šç‹€æ´»æ€§ç¢³ å°è£½åŒ…ç´™ 1050',                  price:300 },
    { id:'cto20_nsf',    size:'20', type:'CTO', badges:['CTO','20å‹','NSF','å°è£½'],  name:'CTO 20" å¡Šç‹€æ´»æ€§ç¢³ å°è£½ NSF 1050',                  price:400 },
    { id:'cto20_sgs',    size:'20', type:'CTO', badges:['CTO','20å‹','SGS','å°è£½'],  name:'CTO 20" å¡Šç‹€æ´»æ€§ç¢³ å°è£½ SGS 1050',                  price:350 },
  ];

  // ====== DOM ======
  const $grid10 = document.getElementById('grid10');
  const $grid20 = document.getElementById('grid20');
  const $q = document.getElementById('q');
  const $filter = document.getElementById('filter');
  const $btnReset = document.getElementById('btnReset');
  const $btnResetTop = document.getElementById('btnResetTop');

  const $cartList = document.getElementById('cartList');
  const $cartCount = document.getElementById('cartCount');
  const $cartUnits = document.getElementById('cartUnits');
  const $cartTotal = document.getElementById('cartTotal');
  const $btnClear = document.getElementById('btnClear');
  const $btnPreview = document.getElementById('btnPreview');
  const $btnCheckout = document.getElementById('btnCheckout');

  const $dlg = document.getElementById('dlg');
  const $cartText = document.getElementById('cartText');

  // ====== Cart state (id -> qty) ======
  const cart = new Map();

  // ====== helpers ======
  function money(n){ return 'NT$ ' + Number(n).toLocaleString('zh-Hant-TW'); }
  function escapeHTML(s){
    return String(s)
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;');
  }
  function chipHTML(b){
    let cls='chip';
    if(b==='NSF') cls='chip good';
    if(b==='SGS') cls='chip warn';
    return `<span class="${cls}">${escapeHTML(b)}</span>`;
  }
  function getProduct(id){ return products.find(p=>p.id===id); }

  function cardHTML(p){
    return `
      <div class="product">
        <div class="img">IMAGE PLACEHOLDER</div>

        <div class="topline">
          <div style="flex:1">
            <div class="title">${escapeHTML(p.name)}</div>
            <div class="meta">${p.badges.map(chipHTML).join('')}</div>
          </div>
          <div class="price">
            <div><b>${money(p.price)}</b></div>
            <div class="hint">å»ºè­°å¸‚åƒ¹</div>
          </div>
        </div>

        <div class="small muted">å» å•†åˆä½œåƒ¹ï¼šå¡«å–®å¾Œå¦è¡Œæä¾›</div>

        <div class="row">
          <div class="qty" data-qty="${p.id}">
            <button type="button" onclick="stepQty('${p.id}', -1)">âˆ’</button>
            <input inputmode="numeric" value="1" aria-label="æ•¸é‡" />
            <button type="button" onclick="stepQty('${p.id}', 1)">ï¼‹</button>
          </div>
          <button class="btn primary" onclick="addToCart('${p.id}')">åŠ å…¥è³¼ç‰©è»Š</button>
        </div>
      </div>
    `;
  }

  function emptyHTML(){
    return `<div class="cartEmpty" style="grid-column:1/-1">
      æ²’æœ‰ç¬¦åˆçš„å“é …ã€‚<br/>æ›å€‹é—œéµå­—ï¼Œæˆ–é»ã€Œé‡ç½®ã€çœ‹çœ‹ã€‚
    </div>`;
  }

  // ====== products render ======
  function renderProducts(){
    const query = ($q.value || '').trim().toLowerCase();
    const f = $filter.value;

    const filtered = products.filter(p=>{
      const hitText = !query
        || p.name.toLowerCase().includes(query)
        || p.badges.join(' ').toLowerCase().includes(query)
        || (p.type || '').toLowerCase().includes(query);

      let hitFilter = true;
      if(f==='10' || f==='20') hitFilter = (p.size===f);
      else if(f==='PP' || f==='UDF' || f==='CTO' || f==='RO') hitFilter = (p.type===f);

      return hitText && hitFilter;
    });

    const list10 = filtered.filter(p=>p.size==='10');
    const list20 = filtered.filter(p=>p.size==='20');

    $grid10.innerHTML = list10.length ? list10.map(cardHTML).join('') : emptyHTML();
    $grid20.innerHTML = list20.length ? list20.map(cardHTML).join('') : emptyHTML();
  }

  // ====== qty ======
  window.stepQty = function(id, delta){
    const el = document.querySelector(`.qty[data-qty="${id}"] input`);
    if(!el) return;
    const v = Math.max(1, Math.min(99, (parseInt(el.value||'1',10) + delta)));
    el.value = v;
  }
  function getQtyFromCard(id){
    const el = document.querySelector(`.qty[data-qty="${id}"] input`);
    const qty = el ? parseInt(el.value||'1',10) : 1;
    if(Number.isFinite(qty)) return Math.max(1, Math.min(99, qty));
    return 1;
  }

  // ====== cart ======
  window.addToCart = function(id){
    const addQty = getQtyFromCard(id);
    const cur = cart.get(id) || 0;
    cart.set(id, Math.max(1, Math.min(99, cur + addQty)));
    renderCart();
  }
  function setCartQty(id, qty){
    const q = Math.max(0, Math.min(99, qty));
    if(q <= 0) cart.delete(id);
    else cart.set(id, q);
    renderCart();
  }

  function cartSummary(){
    const items = [];
    let units = 0;
    let total = 0;
    for(const [id, qty] of cart.entries()){
      const p = getProduct(id);
      if(!p) continue;
      units += qty;
      total += (p.price * qty);
      items.push({id, qty, p});
    }
    return { items, units, total, count: items.length };
  }

  function cartItemHTML(it){
    const { p, qty, id } = it;
    return `
      <div class="cartItem">
        <div style="flex:1">
          <div class="name">${escapeHTML(p.name)}</div>
          <div class="sub2">${p.badges.map(b=>escapeHTML(b)).join('ãƒ»')}ï½œå»ºè­°å¸‚åƒ¹ ${money(p.price)}</div>

          <div class="row" style="margin-top:8px">
            <div class="qty" data-cartqty="${id}">
              <button type="button" onclick="cartStep('${id}', -1)">âˆ’</button>
              <input inputmode="numeric" value="${qty}" aria-label="è³¼ç‰©è»Šæ•¸é‡" oninput="cartInput('${id}', this.value)" />
              <button type="button" onclick="cartStep('${id}', 1)">ï¼‹</button>
            </div>
            <button class="btn" onclick="removeItem('${id}')">ç§»é™¤</button>
          </div>
        </div>

        <div class="right">
          <div><b>${money(p.price * qty)}</b></div>
          <div class="line2">å°è¨ˆ</div>
        </div>
      </div>
    `;
  }

  window.cartStep = function(id, delta){
    const cur = cart.get(id) || 0;
    setCartQty(id, cur + delta);
  }
  window.cartInput = function(id, value){
    const n = parseInt(value || '0', 10);
    if(!Number.isFinite(n)) return;
    setCartQty(id, n);
  }
  window.removeItem = function(id){
    cart.delete(id);
    renderCart();
  }

  function renderCart(){
    const { items, units, total, count } = cartSummary();
    $cartCount.textContent = String(count);
    $cartUnits.textContent = String(units);
    $cartTotal.textContent = money(total);

    if(!items.length){
      $cartList.innerHTML = `
        <div class="cartEmpty">
          é‚„æ²’æœ‰å•†å“å–”ã€‚<br/>
          å·¦é‚Šé¸å¥½æ•¸é‡ â†’ é»ã€ŒåŠ å…¥è³¼ç‰©è»Šã€å°±æœƒå‡ºç¾åœ¨é€™è£¡ ğŸ§º
        </div>`;
      return;
    }
    $cartList.innerHTML = items.map(cartItemHTML).join('');
  }

  // ====== cart text for form ======
  function cartTextSummary(){
    const { items, units, total } = cartSummary();
    if(!items.length) return '';
    const lines = items.map(it => `${it.p.name} Ã—${it.qty}`);
    lines.push('');
    lines.push(`ï¼ˆå»ºè­°å¸‚åƒ¹å°è¨ˆï¼š${money(total)}ï½œç¸½ä»¶æ•¸ï¼š${units}ï¼‰`);
    lines.push('å» å•†åˆä½œåƒ¹ï¼šå¡«å–®å¾Œå¦è¡Œæä¾›');
    return lines.join('\n');
  }

  // ====== modal ======
  window.closeDlg = function(){ $dlg.close(); }
  window.copyText = async function(){
    try{
      await navigator.clipboard.writeText($cartText.value || '');
      alert('å·²è¤‡è£½æ˜ç´° âœ…');
    }catch(e){
      alert('è¤‡è£½å¤±æ•—ï¼Œä½ å¯ä»¥æ‰‹å‹•é¸å–è¤‡è£½ ğŸ¥²');
    }
  }
  function openPreview(title){
    const txt = cartTextSummary();
    if(!txt){ alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„å–” ğŸ˜‚'); return; }
    document.getElementById('dlgTitle').textContent = title || 'è¨‚è³¼æ˜ç´°';
    $cartText.value = txt;
    $dlg.showModal();
  }

  // ====== build google form url ======
  function buildGoogleFormUrl(cartText){
    const u = new URL(FORM_BASE_URL);
    u.searchParams.set('usp','pp_url');
    u.searchParams.set(ENTRY_CART, cartText);
    u.searchParams.set(ENTRY_VENDOR, 'æ˜¯');
    return u.toString();
  }

  // ====== events ======
  function resetFilters(){
    $q.value=''; $filter.value='all'; renderProducts();
  }
  $q.addEventListener('input', renderProducts);
  $filter.addEventListener('change', renderProducts);
  document.getElementById('btnReset').addEventListener('click', resetFilters);
  document.getElementById('btnResetTop').addEventListener('click', resetFilters);

  $btnClear.addEventListener('click', ()=>{
    if(cart.size===0) return;
    if(confirm('è¦æ¸…ç©ºè³¼ç‰©è»Šå—ï¼Ÿ')){
      cart.clear();
      renderCart();
    }
  });

  $btnPreview.addEventListener('click', ()=> openPreview('è¨‚è³¼æ˜ç´°ï¼ˆé è¦½ï¼‰'));

  $btnCheckout.addEventListener('click', ()=>{
    const txt = cartTextSummary();
    if(!txt){ alert('è³¼ç‰©è»Šæ˜¯ç©ºçš„å–” ğŸ˜‚'); return; }
    const url = buildGoogleFormUrl(txt);
    window.open(url, '_blank');
  });

  // init
  renderProducts();
  renderCart();
</script>
</body>
</html>
